## 命令行参数

相关源文件

+   [src/args.rs](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/args.rs)
+   [src/main.rs](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/main.rs)

本文档提供了CloudflareST-Rust中所有命令行参数的完整参考，解释了它们的含义、默认值以及如何影响程序行为。有关安装和基本用法的详细信息，请参阅[安装与使用](https://deepwiki.com/GuangYu-yu/CloudflareST-Rust/2-installation-and-usage)。

## 参数处理流程

当CloudflareST-Rust启动时，它通过以下几个步骤处理命令行参数：

1.  使用`std::env::args()`从命令行收集参数
2.  在`Args`结构体中解析参数并转换为适当类型
3.  验证检查确保提供了必需的参数
4.  为未指定的参数应用默认值
5.  最终的`Args`结构体在整个应用程序中使用

来源: [src/args.rs316-346](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/args.rs#L316-L346) [src/main.rs22-23](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/main.rs#L22-L23)

## 参数结构

命令行参数在`Args`结构体中定义，按逻辑类别组织：

来源: [src/args.rs6-48](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/args.rs#L6-L48)

## 参数类别

CloudflareST-Rust的命令行参数分为五大类：

### 1. 基本配置参数

这些参数定义程序的基本操作，包括IP来源和测试URL：

| 参数 | 描述 | 默认值 |
| --- | --- | --- |
| `-url` | 用于HTTP ping和下载测试的测试URL | 无(HTTP/下载测试必需) |
| `-urlist` | 包含测试URL列表的文件URL | 无 |
| `-f` | 包含IP地址或CIDR块的文件路径 | 无 |
| `-ip` | 直接指定IP或CIDR块(逗号分隔) | 无 |
| `-ipurl` | 包含IP地址或CIDR块的文件URL | 无 |
| `-h` | 显示帮助信息 | `false` |
| `-timeout` | 程序的全局超时(例如"1h3m6s") | 无(无限制) |

**注意：**必须指定至少一个IP来源(`-f`、`-ip`或`-ipurl`)。

来源: [src/args.rs323-329](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/args.rs#L323-L329) [src/args.rs277-286](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/args.rs#L277-L286)

### 2. 网络测试配置

这些参数控制网络测试参数：

| 参数 | 描述 | 默认值 |
| --- | --- | --- |
| `-t` | 每个IP的ping测试次数 | `4` |
| `-dn` | 收集的下载测试结果数量 | `10` |
| `-dt` | 下载测试持续时间(秒) | `10` |
| `-tp` | TCP测试使用的端口 | `443` |
| `-dd` | 禁用下载测试 | `false` |
| `-all4` | 测试范围内的所有IPv4地址 | `false` |
| `-tn` | 找到足够数量的合适IP后停止ping | 无 |

来源: [src/args.rs288-296](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/args.rs#L288-L296)

### 3. 测试模式选择

这些参数决定将使用哪些测试方法：

| 参数 | 描述 | 默认值 |
| --- | --- | --- |
| `-httping` | 使用HTTP ping测试模式 | `false` |
| `-ping` | 使用ICMP ping测试模式 | `false` |
| `-hc` | HTTP ping测试的有效HTTP状态码 | 无(接受200/301/302) |
| `-hu` | 为HTTP ping测试指定URL(逗号分隔) | 无 |
| `-colo` | 按Cloudflare数据中心位置过滤(如"HKG,SJC") | 无 |
| `-n` | 动态线程池的最大线程数 | `1024` |

**注意：**如果未指定`-httping`或`-ping`，则默认使用TCP ping模式。

来源: [src/args.rs298-305](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/args.rs#L298-L305) [src/main.rs44-57](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/main.rs#L44-L57)

### 4. 结果过滤

这些参数设置过滤测试结果的阈值：

| 参数 | 描述 | 默认值 |
| --- | --- | --- |
| `-tl` | 最大可接受延迟(毫秒) | `2000` |
| `-tll` | 最小可接受延迟(毫秒) | `0` |
| `-tlr` | 最大可接受丢包率(0.0-1.0) | `1.0` |
| `-sl` | 最小可接受下载速度(MB/s) | `0.0` |

来源: [src/args.rs308-311](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/args.rs#L308-L311)

### 5. 输出配置

这些参数控制结果的显示和保存方式：

| 参数 | 描述 | 默认值 |
| --- | --- | --- |
| `-p` | 终端显示的结果数量 | `10` |
| `-o` | 输出CSV文件路径 | `result.csv` |

来源: [src/args.rs312-313](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/args.rs#L312-L313)

## 参数解析逻辑

CloudflareST-Rust以灵活的方式解析命令行参数，支持单(`-arg`)和双(`--arg`)破折号前缀。参数解析逻辑处理带值和不带值的标志参数。

来源: [src/args.rs90-240](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/args.rs#L90-L240)

## 验证和默认值

一些参数需要额外验证：

1.  **IP来源要求**：必须指定至少一个IP来源(`-f`、`-ipurl`或`-ip`)
2.  **HTTP测试URL要求**：使用`-httping`时，必须通过`-hu`、`-url`或`-urlist`指定URL
3.  **下载测试URL要求**：启用下载测试(无`-dd`)时，必须通过`-url`或`-urlist`指定URL

默认值在`Args::new()`方法中设置，确保即使未指定参数，程序也有合理的默认值。

来源: [src/args.rs51-88](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/args.rs#L51-L88) [src/args.rs323-343](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/args.rs#L323-L343)

## 持续时间解析

CloudflareST-Rust对基于持续时间的参数(`-timeout`、`-dt`)使用特殊解析器，支持多种格式：

1.  纯数字(解释为秒)
2.  人类可读的持续时间(如"1h30m"、"5m10s")

来源: [src/args.rs244-266](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/args.rs#L244-L266)

## 常见参数组合

不同的测试场景通常使用不同的参数组合：

### TCP Ping测试(默认)

基本的TCP连接和延迟测试：

```text
CloudflareST-Rust -f ip.txt -o results.csv
```

### HTTP Ping测试

测试Web服务的HTTP响应时间：

```text
CloudflareST-Rust -f ip.txt -httping -url https://example.com
```

### ICMP Ping测试

使用ICMP数据包的经典ping测试：

```text
CloudflareST-Rust -f ip.txt -ping
```

### 带过滤器的完整测试

带有筛选标准的全面测试：

```text
CloudflareST-Rust -f ip.txt -url https://example.com -tl 100 -tlr 0.05 -sl 10 -t 10
```

来源: [src/main.rs44-57](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/main.rs#L44-L57)

## 命令行帮助

应用程序通过`-h`参数提供全面的帮助列表，显示按类别组织的所有可用参数。这在`print_help()`函数中实现。

来源: [src/args.rs274-314](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/args.rs#L274-L314)

## 全局超时机制

`global_timeout`参数设置整个程序的最大执行时间。当指定时，CloudflareST-Rust将：

1.  将持续时间字符串解析为`Duration`值
2.  创建一个原子布尔标志(`timeout_flag`)
3.  生成一个后台线程，在超时周期后设置标志
4.  在程序流程的关键点检查此标志以允许提前终止

来源: [src/args.rs219-222](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/args.rs#L219-L222) [src/main.rs26-36](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/main.rs#L26-L36) [src/main.rs60-68](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/main.rs#L60-L68)

## 与其他组件的关系

`Args`结构体和解析的参数传递给应用程序中的各个组件：

来源: [src/main.rs44-57](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/main.rs#L44-L57) [src/main.rs70](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/main.rs#L70-L70) [src/main.rs77](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/main.rs#L77-L77)

## 结论

CloudflareST-Rust中的命令行参数系统提供了一个灵活而强大的接口来控制应用程序的行为。通过结合必需和可选参数，用户可以精确调整测试过程以满足特定需求，同时依赖未指定参数的合理默认值。