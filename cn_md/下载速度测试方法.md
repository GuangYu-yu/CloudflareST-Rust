## 下载速度测试方法

相关源文件

+   [src/common.rs](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/common.rs)
+   [src/download.rs](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/download.rs)

本文档详细介绍了CloudflareST-Rust中的下载速度测试组件，该组件评估Cloudflare CDN端点的带宽性能。下载速度测试在初始ping测试(HTTP、TCP或ICMP)之后进行，旨在测量从选定IP地址的实际吞吐量。本页重点介绍下载速度测量功能的具体实现和行为。

有关下载测试前的初始ping测试方法，请参阅[HTTP Ping测试](https://deepwiki.com/GuangYu-yu/CloudflareST-Rust/4.1-http-ping-testing)、[TCP Ping测试](https://deepwiki.com/GuangYu-yu/CloudflareST-Rust/4.2-tcp-ping-testing)和[ICMP Ping测试](https://deepwiki.com/GuangYu-yu/CloudflareST-Rust/4.3-icmp-ping-testing)。

## 概述

下载速度测试模块评估从Cloudflare服务器可达到的实际数据传输速率。它采用采样方法来准确测量吞吐量，同时限制测试持续时间。系统支持：

+   可配置的最低速度阈值
+   多URL测试
+   数据中心(colo)过滤
+   EWMA(指数加权移动平均)实现稳定测量
+   与进度显示子系统的集成

来源: [src/download.rs149-182](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/download.rs#L149-L182) [src/download.rs335-453](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/download.rs#L335-L453)

## 架构与集成

下载测试是一个可选阶段，在初始ping测试完成后运行。它从ping测试中获取性能最佳的IP，并测量它们的下载性能。

来源: [src/download.rs149-182](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/download.rs#L149-L182) [src/download.rs216-333](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/download.rs#L216-L333)

## 关键组件

### DownloadTest结构体

下载测试的核心组件是`DownloadTest`结构体，它管理整个测试过程：

来源: [src/download.rs149-216](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/download.rs#L149-L216) [src/download.rs47-147](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/download.rs#L47-L147) [src/download.rs17-44](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/download.rs#L17-L44)

## 下载速度测量流程

下载测试遵循精确的操作序列：

1.  使用ping结果和配置参数初始化`DownloadTest`
2.  对于过滤后的ping结果中的每个IP：
    +   使用IP连接到目标URL
    +   下载配置持续时间的数据
    +   使用EWMA计算测量吞吐量
    +   记录并显示实时速度
3.  根据最低速度和colo要求过滤结果
4.  按下载速度、延迟和丢包率对结果排序

来源: [src/download.rs216-333](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/download.rs#L216-L333) [src/download.rs335-453](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/download.rs#L335-L453)

## 速度计算方法论

下载速度测量采用多种技术确保准确读数：

### 1. 移动窗口采样

系统维护一个500ms的滚动数据点窗口来计算当前速度：

```text
speed_samples: VecDeque<(Instant, u64)>
```

当新数据到达时：

+   将当前时间戳和累计数据添加到队列
+   移除超过500ms的旧样本
+   基于窗口中第一个和最后一个样本计算速度

来源: [src/download.rs83-113](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/download.rs#L83-L113)

### 2. 指数加权移动平均(EWMA)

为了平滑速度波动，系统实现EWMA：

```text
ewma.add(content_diff as f32)
```

这给予近期测量更多权重，同时仍考虑历史数据，产生更稳定的读数。

来源: [src/download.rs17-44](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/download.rs#L17-L44) [src/download.rs123-137](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/download.rs#L123-L137)

### 3. 时间片处理

速度测量分为100ms的时间片：

```text
time_slice: Duration::from_millis(100)
```

每个时间片都贡献于EWMA计算，有助于平衡网络抖动并提供一致的测量。

来源: [src/download.rs70-71](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/download.rs#L70-L71) [src/download.rs123-137](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/download.rs#L123-L137)

## 结果处理与过滤

下载测试后，根据多个标准处理结果：

1.  **最低速度**：结果必须超过配置的最低速度(以MB/s为单位)
2.  **数据中心(Colo)过滤**：可选按Cloudflare数据中心标识符过滤
3.  **排序**：结果按以下方式排序：
    +   下载速度(降序)
    +   Ping延迟(升序)
    +   丢包率(升序)

来源: [src/download.rs166-182](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/download.rs#L166-L182) [src/common.rs328-361](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/common.rs#L328-L361)

## 数据结构

### PingData

来自ping和下载测试的结果都存储在`PingData`结构中：

| 字段 | 类型 | 描述 |
| --- | --- | --- |
| ip | IpAddr | 被测试的IP地址 |
| sent | u16 | 发送的数据包数量 |
| received | u16 | 接收的数据包数量 |
| delay | f32 | 平均ping延迟(毫秒) |
| download_speed | Option<f32> | 下载速度(字节/秒，如果测试过) |
| data_center | String | Cloudflare数据中心标识符 |

下载测试阶段专门更新`download_speed`和(如果需要)`data_center`字段。

来源: [src/common.rs16-43](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/common.rs#L16-L43)

## 配置参数

下载测试行为可以通过多个命令行参数自定义：

| 参数 | 描述 | 默认值 |
| --- | --- | --- |
| `--disable-download` | 跳过下载测试 | false |
| `--url` | 下载测试的URL | `http://1.1.1.1/cdn-cgi/trace` |
| `--urlist` | 指向测试URL列表的URL | 空 |
| `--min-speed` | 最低要求速度(MB/s) | 0.0 |
| `--test-count` | 测试下载的IP数量 | 10 |
| `--httping-cf-colo` | 按Cloudflare数据中心代码过滤 | 空 |

来源: [src/download.rs184-216](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/download.rs#L184-L216) [src/common.rs328-361](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/common.rs#L328-L361)

## 实时进度显示

下载测试组件与进度显示子系统集成，显示实时速度信息：

1.  专用任务用当前速度(MB/s)更新进度条
2.  当前速度存储在thread-safe的`Arc<Mutex<f32>>`中
3.  大约每500ms更新一次，平衡响应性和稳定性

来源: [src/download.rs232-249](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/download.rs#L232-L249) [src/download.rs96-120](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/download.rs#L96-L120)

## 错误处理与超时管理

下载测试系统实现多种错误处理机制：

1.  **超时检测**：测试受可配置持续时间限制
2.  **全局超时标志**：`AtomicBool`允许优雅中断
3.  **连接失败**：失败的连接导致零速度并被过滤掉
4.  **HTTP错误处理**：正确处理失败的HTTP响应

来源: [src/download.rs394-407](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/download.rs#L394-L407) [src/download.rs253-255](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/download.rs#L253-L255)

## 实现说明

1.  实现优先考虑准确测量而非最大化吞吐量
2.  持续请求小块数据而非单个大文件
3.  对部分时间片的特殊处理确保准确测量
4.  系统设计用于与Cloudflare的CDN架构配合工作，并报告数据中心信息

来源: [src/download.rs409-434](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/download.rs#L409-L434) [src/download.rs383-387](https://github.com/GuangYu-yu/CloudflareST-Rust/blob/57de4236/src/download.rs#L383-L387)