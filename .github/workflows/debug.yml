name: Debug

# 触发条件：手动工作流调度
on:
  workflow_dispatch:
    inputs:
      project_name:
        type: string
        default: 'CloudflareST-Rust'
        required: true
      # 各平台构建选项
      build_windows_amd64:
        type: boolean
        default: true
      build_windows_arm64:
        type: boolean
        default: true
      build_linux_amd64:
        type: boolean
        default: true
      build_linux_arm64:
        type: boolean
        default: true
      build_macos_amd64:
        type: boolean
        default: true
      build_macos_arm64:
        type: boolean
        default: true

jobs:
  # 动态生成矩阵配置，只包含用户勾选的平台
  matrix:
    name: 矩阵配置
    runs-on: ubuntu-latest
    outputs:
      include: ${{ steps.set.outputs.include }}
    steps:
      - id: set
        name: 生成矩阵配置
        run: |
          # 根据用户输入动态构建矩阵
          arr=()
          [[ "${{ inputs.build_windows_amd64 }}" == true ]] && arr+=('{"os":"Windows","arch":"AMD64","target":"x86_64-pc-windows-msvc","runner":"windows-latest","bin":"${{ inputs.project_name }}.exe"}')
          [[ "${{ inputs.build_windows_arm64 }}" == true ]] && arr+=('{"os":"Windows","arch":"ARM64","target":"aarch64-pc-windows-msvc","runner":"windows-latest","bin":"${{ inputs.project_name }}.exe"}')
          [[ "${{ inputs.build_linux_amd64 }}"   == true ]] && arr+=('{"os":"Linux","arch":"AMD64","target":"x86_64-unknown-linux-musl","runner":"ubuntu-latest","bin":"${{ inputs.project_name }}"}')
          [[ "${{ inputs.build_linux_arm64 }}"   == true ]] && arr+=('{"os":"Linux","arch":"ARM64","target":"aarch64-unknown-linux-musl","runner":"ubuntu-latest","bin":"${{ inputs.project_name }}"}')
          [[ "${{ inputs.build_macos_amd64 }}"   == true ]] && arr+=('{"os":"MacOS","arch":"AMD64","target":"x86_64-apple-darwin","runner":"macos-latest","bin":"${{ inputs.project_name }}"}')
          [[ "${{ inputs.build_macos_arm64 }}"   == true ]] && arr+=('{"os":"MacOS","arch":"ARM64","target":"aarch64-apple-darwin","runner":"macos-latest","bin":"${{ inputs.project_name }}"}')
          echo "include=[${arr[*]}]" >> $GITHUB_OUTPUT

  # 构建作业：根据动态矩阵为每个平台构建debug版本
  build:
    needs: matrix
    # 只有当矩阵不为空时才执行构建
    if: ${{ needs.matrix.outputs.include != '[]' }}
    runs-on: ${{ matrix.runner }}
    strategy:
      matrix:
        include: ${{ fromJson(needs.matrix.outputs.include) }}
    name: ${{ matrix.os }}_${{ matrix.arch }}
    steps:
      # 检出代码
      - name: 检出代码
        uses: actions/checkout@v4

      # 安装Rust工具链和目标平台
      - name: 安装Rust工具链和目标平台
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      # Linux平台需要安装MUSL工具链
      - if: startsWith(matrix.os, 'Linux')
        name: 安装MUSL工具链
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y musl-tools
          rustup target add ${{ matrix.target }}

      # 执行debug模式构建
      - name: 执行debug模式构建
        run: cargo build --target ${{ matrix.target }}

      # 准备构建产物
      - name: 准备构建产物
        run: |
          mkdir -p debug/${{ matrix.os }}_${{ matrix.arch }}
          cp target/${{ matrix.target }}/debug/${{ matrix.bin }} debug/${{ matrix.os }}_${{ matrix.arch }}/

      # 上传构建产物作为工件
      - name: 上传构建产物作为工件
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.os }}_${{ matrix.arch }}
          path: debug/${{ matrix.os }}_${{ matrix.arch }}/

  # 上传作业：将构建产物上传到仓库的debug目录
  upload:
    name: 上传
    needs: build
    runs-on: ubuntu-latest
    # 只有当构建成功时才执行上传
    if: needs.build.result == 'success'
    steps:
      # 检出代码
      - name: 检出代码
        uses: actions/checkout@v4

      # 配置Git用户信息
      - name: 配置Git用户信息
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      # 下载所有构建产物
      - name: 下载所有构建产物
        uses: actions/download-artifact@v4
        with:
          path: debug

      # 显示下载的文件列表
      - name: 显示下载的文件列表
        run: find debug -type f | sort

      # 提交并推送二进制文件到仓库
      - name: 提交并推送二进制文件到仓库
        run: |
          git add debug/
          git diff --staged --quiet || (
            git commit -m "Debug: ${{ inputs.project_name }} binaries [skip ci]" && git push
          )
