name: Debug

on:
  workflow_dispatch:
    inputs:
      project_name:
        description: '项目名称'
        type: string
        default: 'CloudflareST-Rust'
        required: true
      build_windows_amd64:
        description: '编译 Windows AMD64 版本'
        type: boolean
        default: true
      build_windows_arm64:
        description: '编译 Windows ARM64 版本'
        type: boolean
        default: true
      build_linux_amd64:
        description: '编译 Linux AMD64 版本'
        type: boolean
        default: true
      build_linux_arm64:
        description: '编译 Linux ARM64 版本'
        type: boolean
        default: true
      build_macos_amd64:
        description: '编译 MacOS AMD64 版本'
        type: boolean
        default: true
      build_macos_arm64:
        description: '编译 MacOS ARM64 版本'
        type: boolean
        default: true

jobs:
  build:
    name: 构建 ${{ matrix.os }}_${{ matrix.arch }}
    runs-on: ${{ matrix.runner }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: Windows
            runner: windows-latest
            arch: AMD64
            target: x86_64-pc-windows-msvc
            binary_name: ${{ github.event.inputs.project_name }}.exe
            build_option: build_windows_amd64
          - os: Windows
            runner: windows-latest
            arch: ARM64
            target: aarch64-pc-windows-msvc
            binary_name: ${{ github.event.inputs.project_name }}.exe
            build_option: build_windows_arm64
          - os: Linux
            runner: ubuntu-latest
            arch: AMD64
            target: x86_64-unknown-linux-musl
            binary_name: ${{ github.event.inputs.project_name }}
            build_option: build_linux_amd64
          - os: Linux
            runner: ubuntu-latest
            arch: ARM64
            target: aarch64-unknown-linux-musl
            binary_name: ${{ github.event.inputs.project_name }}
            build_option: build_linux_arm64
          - os: MacOS
            runner: macos-latest
            arch: AMD64
            target: x86_64-apple-darwin
            binary_name: ${{ github.event.inputs.project_name }}
            build_option: build_macos_amd64
          - os: MacOS
            runner: macos-latest
            arch: ARM64
            target: aarch64-apple-darwin
            binary_name: ${{ github.event.inputs.project_name }}
            build_option: build_macos_arm64

    steps:
      - uses: actions/checkout@v4

      - name: 判断是否需要构建
        if: ${{ github.event.inputs[matrix.build_option] == false }}
        run: echo "跳过 ${{ matrix.os }}_${{ matrix.arch }} 构建" && exit 0

      - name: 安装 Rust 工具链
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: 安装 MUSL (仅 Linux)
        if: startsWith(matrix.os, 'Linux')
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools
          rustup target add ${{ matrix.target }}

      - name: 构建项目
        run: cargo build --target ${{ matrix.target }}

      - name: 保存 Debug 二进制
        run: |
          mkdir -p debug/${{ matrix.os }}_${{ matrix.arch }}
          cp target/${{ matrix.target }}/debug/${{ matrix.binary_name }} debug/${{ matrix.os }}_${{ matrix.arch }}/

      - name: 上传 Debug artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.inputs.project_name }}-${{ matrix.os }}_${{ matrix.arch }}
          path: debug/${{ matrix.os }}_${{ matrix.arch }}/

  upload_to_repo:
    name: 上传 Debug 二进制到仓库
    needs: build
    runs-on: ubuntu-latest
    if: needs.build.result == 'success'
    steps:
      - uses: actions/checkout@v4

      - name: 设置 Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: 下载所有构建产物
        uses: actions/download-artifact@v4
        with:
          path: debug

      - name: 整理 debug 目录
        run: |
          echo "最终目录结构:"
          find debug -type f | sort

      - name: 提交并推送
        run: |
          git add debug/
          if git diff --staged --quiet; then
            echo "没有文件需要提交"
          else
            git commit -m "添加调试版本二进制文件 [skip ci]"
            git push
          fi
