FROM --platform=$BUILDPLATFORM rust:alpine as builder

ARG RUST_TARGET
ARG BUILDPLATFORM
ARG TARGETPLATFORM

# 安装构建依赖
RUN apk add --no-cache musl-dev gcc g++ make openssl-dev pkgconfig

# 安装 Rust 目标
RUN rustup target add ${RUST_TARGET}

# 创建非 root 用户
RUN adduser -D -u 1000 rust
USER rust
WORKDIR /home/rust

# 复制项目文件
COPY --chown=rust:rust . .

# 构建项目
RUN cargo build --release --target ${RUST_TARGET}

# 确保输出目录存在
RUN mkdir -p /home/rust/target/${RUST_TARGET}/release
