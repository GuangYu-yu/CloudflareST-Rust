```mermaid
sequenceDiagram
    participant User as 用户
    participant Main as main.rs
    participant Args as args.rs
    participant Pool as pool.rs
    participant Interface as interface.rs
    participant IP as ip.rs
    participant TCPing as tcping.rs
    participant HTTPing as httping.rs
    participant Common as common.rs
    participant Download as download.rs
    participant Progress as progress.rs
    participant CSV as csv.rs
    
    User->>Main: 启动程序并提供参数
    Main->>Args: 解析命令行参数
    note over Args: 解析过程中调用Interface处理接口参数
    Args->>Interface: 验证接口参数有效性
    Interface-->>Args: 返回接口验证结果
    Args-->>Main: 返回解析后的参数(含接口信息)
    
    Main->>Pool: 初始化全局并发限制器
    Pool-->>Main: 并发限制器初始化完成
    
    Main->>Main: 创建超时标志(AtomicBool)
    Main->>Main: 设置全局超时线程(可选)
    
    alt 选择HTTP测速模式
        Main->>HTTPing: 创建HTTP测速实例
        HTTPing->>HTTPing: 初始化测试环境
        note over HTTPing: 在初始化过程中创建IP缓冲区
        HTTPing->>IP: 创建IP缓冲区(IpBuffer)
        
        note over IP: IP处理流程(无锁链表+CIDR)
        IP->>IP: 收集IP源(文件/文本/URL)
        IP->>IP: 解析IP范围和CIDR
        IP->>IP: 创建LockFreeIpList和CidrState
        IP-->>HTTPing: 返回IP缓冲区
        
        HTTPing->>HTTPing: 创建HttpingHandlerFactory
        HTTPing->>Progress: 创建进度条(Bar)
        
        loop 处理每个IP(并发控制)
            par 并发处理多个IP
                HTTPing->>IP: 获取下一个IP(pop)
                IP-->>HTTPing: 返回SocketAddr
                
                HTTPing->>HTTPing: 构建URL(轮询URL列表)
                HTTPing->>HTTPing: 创建HTTP客户端(含接口绑定)
                note over HTTPing: 在客户端创建时绑定接口
                HTTPing->>HTTPing: 发送HTTP HEAD请求
                
                note over HTTPing: 通过execute_with_rate_limit处理并发
                HTTPing->>Pool: 获取并发许可(异步)
                Pool-->>HTTPing: 返回并发许可
                
                HTTPing->>HTTPing: 计算延迟
                HTTPing->>HTTPing: 提取数据中心信息
                HTTPing->>HTTPing: 检查状态码和过滤条件
                HTTPing->>Common: 更新测试结果(PingData)
                HTTPing->>Progress: 异步更新进度条
                
                HTTPing->>Pool: 释放并发许可(异步)
                Pool-->>HTTPing: 确认释放
            end
        end
        
        HTTPing-->>Main: 返回测速结果(PingDelaySet)
    else TCP测速模式
        Main->>TCPing: 创建TCP测速实例
        TCPing->>TCPing: 初始化测试环境
        note over TCPing: 在初始化过程中创建IP缓冲区
        TCPing->>IP: 创建IP缓冲区(IpBuffer)
        
        note over IP: IP处理流程(无锁链表+CIDR)
        IP->>IP: 收集IP源(文件/文本/URL)
        IP->>IP: 解析IP范围和CIDR
        IP->>IP: 创建LockFreeIpList和CidrState
        IP-->>TCPing: 返回IP缓冲区
        
        TCPing->>TCPing: 创建TcpingHandlerFactory
        TCPing->>Progress: 创建进度条(Bar)
        
        loop 处理每个IP(并发控制)
            par 并发处理多个IP
                TCPing->>IP: 获取下一个IP(pop)
                IP-->>TCPing: 返回SocketAddr
                
                TCPing->>TCPing: 创建TCP连接(含接口绑定)
                note over TCPing: 在连接创建时绑定接口
                
                note over TCPing: 通过execute_with_rate_limit处理并发
                TCPing->>Pool: 获取并发许可(异步)
                Pool-->>TCPing: 返回并发许可
                
                TCPing->>TCPing: 计算延迟
                TCPing->>Common: 更新测试结果(PingData)
                TCPing->>Progress: 异步更新进度条
                
                TCPing->>Pool: 释放并发许可(异步)
                Pool-->>TCPing: 确认释放
            end
        end
        
        TCPing-->>Main: 返回测速结果(PingDelaySet)
    end
    
    alt 不禁用下载测速且有延迟测速结果
        Main->>Download: 创建下载测速实例
        Download->>Download: 获取URL列表
        Download->>Progress: 创建下载进度条
        
        note over Download: 下载测速流程(速度采样+数据中心过滤)
        loop 处理每个IP(串行)
            Download->>Download: 选择测试URL(轮询)
            Download->>Download: 创建DownloadHandler(含接口绑定)
            note over Download: 在处理器创建时绑定接口
            Download->>Download: 构建HTTP客户端
            Download->>Download: 发送HTTP GET请求
            
            loop 下载数据块(预热+实际测试)
                Download->>Download: 读取数据块
                Download->>Download: 更新接收数据量
                Download->>Download: 计算实时速度(滑动窗口采样)
                Download->>Download: 更新速度样本队列
                Download->>Progress: 异步更新速度显示
            end
            
            Download->>Download: 计算平均下载速度(预热后)
            Download->>Download: 提取数据中心信息
            Download->>Download: 检查数据中心过滤条件
            Download->>Download: 更新测试结果
            Download->>Progress: 异步更新进度条
        end
        
        Download->>Download: 筛选合格结果(速度阈值+数据中心)
        Download->>Download: 排序结果(综合评分算法)
        Download-->>Main: 返回下载测速结果
    end
    
    Main->>CSV: 导出CSV结果(可选)
    CSV->>CSV: 创建CSV写入器
    CSV->>CSV: 写入表头和数据行
    CSV-->>Main: 完成导出
    
    Main->>CSV: 打印结果表格
    CSV->>CSV: 创建表格(Table)
    CSV->>CSV: 添加表头和数据行
    CSV-->>Main: 完成表格创建
    
    Main->>Progress: 完成进度条显示
    Progress-->>Main: 进度条完成
    Main-->>User: 显示最终结果
```
